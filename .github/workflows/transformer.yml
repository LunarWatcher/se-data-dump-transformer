name: Data dump transformer build
on:
  push:
    branches: [ master ]
    paths:
      - transformer/*
  pull_request:
    branches: [ master ]
    paths:
      - transformer/*
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{matrix.os}}
    defaults:
      run:
        working-directory: ./transformer/
    steps:
      - uses: actions/checkout@main
      - name: Install deps (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update && sudo apt upgrade -y
      - name: Print environment
        run: |
          cmake --version
      - name: Run build
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DSEDD_SANITIZE=ON
          cmake --build . -j 2
      - name: Run test
        run: |
          cd build
          cmake --build . -j 2 --target test
  clang-tidy:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy
      - name: Generate fixes.yml
        run: |
          cd transformer
          mkdir build 
          cd build
          cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DLINT=ON -DLINT_EXPORT=ON
          make -j 2
      - name: Run clang-tidy-pr-comments action
        uses: platisd/clang-tidy-pr-comments@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          clang_tidy_fixes: transformer/build/fixes.yml
          request_changes: true
          suggestions_per_comment: 10
